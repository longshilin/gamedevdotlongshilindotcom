---
layout: post
title: "Launcherå¯åŠ¨å™¨ç±»"
date: 2019-12-10
categories: Lockstepæºç ç¬”è®°
tags: Lockstepæºç 
excerpt: Lockstepä¸­Launcherå¯åŠ¨å™¨ç±»
mathjax: true
---

* content
{:toc}

Launcherå¯åŠ¨å™¨æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„ç»„ä»¶ï¼Œå› ä¸ºå®ƒæ‰¿æ‹…ç€å°†Unityçš„ç”Ÿå‘½å‘¨æœŸå’Œæ¡†æ¶çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„è°ƒåº¦æ¡¥æ¢çš„ä½œç”¨ã€‚å¯ä»¥è¯´æ˜¯æ¡†æ¶å†…æ¸¸æˆç”Ÿå‘½å‘¨æœŸæœ€æ ¸å¿ƒçš„ç®¡ç†ç±»äº†ã€‚

é¦–å…ˆå¯åŠ¨å™¨ç®¡ç†ç±»æ‹¿åˆ°ä¸€äº›Serviceæ¨¡å—çš„å˜é‡ï¼Œè¿™äº›æ˜¯ç®¡ç†å™¨ç±»ä¸­éœ€è¦ç”¨åˆ°çš„ã€‚

ğŸ’¬ æ³¨æ„ï¼šè·å–å€¼æœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ—¶é€šè¿‡æ–¹æ³•çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯èµ‹å€¼çš„æ–¹å¼ã€‚è¿™ä¸¤è€…çš„åŒºåˆ«åœ¨äºæ–¹æ³•è·å–å¯ä»¥æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œè€Œèµ‹å€¼æ–¹å¼æ‹¿çš„æ˜¯å›ºå®šä¸ä¼šä¿®æ”¹çš„å€¼ã€‚æ‰€ä»¥å¯¹äºå…¨å±€åˆå§‹åŒ–çš„å±æ€§ï¼Œç›´æ¥é€šè¿‡èµ‹å€¼æ–¹å¼ï¼Œå¯¹äºè¦åŠ¨æ€æ‹¿æœ€æ–°å€¼ï¼Œå¦‚ç›®å‰è¿è¡Œå¸§æ•°ï¼Œåˆ™é€šè¿‡æ–¹æ³•çš„æ–¹å¼ã€‚

```c#
// æ–¹æ³•è·å–æœ€æ–°çš„å€¼
public int CurTick => _serviceContainer.GetService<ICommonStateService>().Tick;
public bool IsRunVideo => _constStateService.IsRunVideo;

// å–å›ºå®šå€¼
public int JumpToTick = 10;
```



##### DoAwake

å®ä¾‹åŒ–ManagerContianerï¼Œå¹¶å°†å…¨å±€çš„serviceContianerå®¹å™¨ä¸­ï¼Œå®ç°ITimeMachineæ¥å£çš„ç±»éƒ½æ³¨å†Œåˆ°managerContianerä¸­ã€‚å¦å¤–å®ä¾‹åŒ–EventRegisterServiceå’ŒTimeMachineContianerï¼Œå¹¶æ³¨å†Œåˆ°å…¨å±€çš„serviceContaineræœåŠ¡ç®¡ç†å®¹å™¨å†…ã€‚

ç›®å‰ï¼Œå…¨å±€_serviceContainerä¸­æ³¨å†Œçš„ç±»å…±13ä¸ªï¼ŒåŒ…æ‹¬ï¼š

```text
RandomService
CommonStateService
ConstStateService
SimulatorService
NetworkService
IdService
GameResourceService
GameStateService
GameConfigService
GameInputService
UnityGameViewService
TimeMachineContainer
EventRegisterService
```

ManagerContainerä¸­åŒ…æ‹¬çš„ç±»ï¼š
```text
RandomService
ConstStateService
SimulatorService
NetworkService
GameResourceService
GameStateService
GameConfigService
UnityGameViewService
```

è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ¥è¯´è¯´ServiceContainerä¸­ç‹¬æœ‰çš„RegisterServiceæ–¹æ³•

```c#
public void RegisterService(IService service, bool overwriteExisting = true){
	var interfaceTypes = service.GetType().FindInterfaces((type, criteria) =>
			type.GetInterfaces().Any(t => t == typeof(IService)), service)
		.ToArray();

	foreach (var type in interfaceTypes) {
		if (!_allServices.ContainsKey(type))
			_allServices.Add(type, service);
		else if (overwriteExisting) {
			_allServices[type] = service;
		}
	}
}
```

â‘  æˆ‘ä»¬å‡å®šè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ˜¯ä¸‹é¢è¿™æ¡è¯­å¥ï¼š

```c#
RegisterService(new RandomService());
```
è€Œä¸”å·²çŸ¥RandomServiceçš„UMLå…³ç³»å›¾é•¿ä¸‹é¢è¿™æ ·ï¼š
![](https://longshilin.com/images/20191028150114.png)

åœ¨ä¸Šé¢ä»£ç çš„ç¬¬ä¸€æ®µçš„æ„æ€æ˜¯ï¼šåœ¨ç”±å½“å‰RandomServiceæ‰€å®ç°æˆ–ç»§æ‰¿çš„æ¥å£çš„ç­›é€‰åˆ—è¡¨çš„å¯¹è±¡æ•°ç»„ï¼ˆå³IRandomServiceï¼‰ï¼Œç­›é€‰å‡ºç”±`IRandomService`æ‰€å®ç°æˆ–ç»§æ‰¿çš„æ¥å£å¯¹è±¡æ•°ç»„ä¸­ç±»å‹ä¸ºIServiceçš„æ¥å£ï¼ˆå³IRandomServiceï¼‰ã€‚

ç¬¬äºŒæ®µforeachçš„æ„æ€æ˜¯ï¼šéå†ä¸Šé¢æ‰¾åˆ°çš„æ¥å£å¯¹è±¡æ•°ç»„ï¼Œç„¶åæ ¹æ®æ¥å£ç±»å‹å’Œå¯¹åº”çš„æ¥å£å®ç°æˆ–ç»§æ‰¿ç±»Serviceï¼Œç»„æˆä¸€ä¸ªå­—å…¸ä¿å­˜ï¼Œå¦‚æœæ”¯æŒè¦†ç›–ï¼Œé‚£ä¹ˆä¼šè¦†ç›–æ›´æ–°keyå€¼ç›¸åŒçš„Serviceå€¼ã€‚

â‘¡ æˆ‘ä»¬å‡å®šè°ƒç”¨çš„æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„å¯¹è±¡å‚æ•°ï¼š
```c#
RegisterService(new TimeMachineContainer());
```
å·²çŸ¥TimeMachineContainerçš„UMLå…³ç³»å›¾å¦‚ä¸‹ï¼š

![](https://longshilin.com/images/20191028161708.png)

æ¥ç€åˆ†æä»£ç ç‰‡æ®µä¸­ç¬¬ä¸€æ®µä¸­çš„æ„æ€æ˜¯ï¼šåœ¨ç”±å½“å‰`TimeMachineContainer`æ‰€å®ç°æˆ–ç»§æ‰¿çš„æ¥å£çš„ç­›é€‰åˆ—è¡¨çš„å¯¹è±¡æ•°ç»„ï¼ˆå³`ITimeMachineContainer` å’Œ `ITimeMachineService`ï¼‰ï¼Œä»ä¸­ç­›é€‰å‡ºç”±`ITimeMachineContainer` æˆ– `ITimeMachineService`æ‰€å®ç°æˆ–ç»§æ‰¿çš„æ¥å£å¯¹è±¡æ•°ç»„ä¸­ç±»å‹ä¸ºIServiceçš„æ¥å£ï¼Œä»¥ä¸Šä¸¤è€…éƒ½æ»¡è¶³æ¡ä»¶ï¼Œå³è¿”å›çš„æ¥å£å¯¹è±¡æ•°ç»„æ˜¯`ITimeMachineContainer` å’Œ `ITimeMachineService`ã€‚

